<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KidsLabï½œEnglish Practice</title>
  <link rel="stylesheet" href="../KidsLabTheme-vFinal.css">
  <link rel="preload" as="font" href="../BpmfIansui-Regular.ttf" type="font/ttf" crossorigin>
  <link rel="preload" as="font" href="../Iansui-Regular.ttf" type="font/ttf" crossorigin>
  <style>
    @font-face {
      font-family: 'BpmfIansui';
      src: url('../BpmfIansui-Regular.ttf') format('truetype');
      font-display: swap;
    }
    :root { --card-w: 920px; }

    body, button, .btn, .chip, .opt, .question, .seg, label {
      font-family: 'BpmfIansui','Iansui-Regular','Noto Sans TC',sans-serif;
    }

    body { max-width: var(--card-w); margin: 0 auto; padding: 16px; }
    header h1 { margin: 8px 0 4px; }
    .lead { opacity:.8; margin:0 0 16px; }

    .toolbar { display:grid; gap:10px; margin:10px 0 14px; }
    .seg { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    .chip {
      border: 2px solid var(--b2);
      border-radius: 999px;
      padding: 6px 12px;
      cursor: pointer;
      user-select: none;
    }
    .chip.active {
      background: var(--b2);
      color: var(--text-strong);
      font-weight: 700;
    }

    .panel {
      border: 2px solid var(--b2);
      border-radius: 16px;
      padding: 16px;
      background: var(--b1);
    }

    .opt {
      display: inline-block;
      background: var(--b1);
      border: 2px solid var(--b3);
      border-radius: 12px;
      padding: 12px 18px;
      margin: 6px;
      font-size: 22px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .opt:hover {
      background: var(--b2);
      color: var(--text-strong);
    }
    .opt.correct {
      border-color: var(--success);
      background: var(--success-soft);
    }
    .opt.wrong {
      border-color: var(--error);
      background: var(--error-soft);
    }

    .actions {
      margin-top: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn.primary {
      background: var(--b2);
      color: var(--text-strong);
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
    }
    .btn.ghost {
      background: var(--b1);
      border: 2px solid var(--b2);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
    }

    .kbd {
      font-size: 22px;
      border: 2px solid var(--b3);
      border-radius: 8px;
      padding: 8px 12px;
      min-width: 28px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
    }
    .slots {
      display: flex;
      gap: 10px;
      font-size: 28px;
      letter-spacing: 6px;
      justify-content: center;
      margin-bottom: 12px;
    }
    .letters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .toast {
      position: fixed;
      left: 50%;
      top: 18px;
      transform: translateX(-50%);
      background:#111;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      opacity:0;
      transition:opacity .18s;
    }
    .toast.show { opacity:1; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§  KidsLabï½œEnglish Practice</h1>
    <p class="lead">å››ä¸»é¡Œï¼šå‹•ç‰©ã€é£Ÿç‰©ã€ç‰©å“ã€ç”Ÿæ´»å¥å‹ã€‚</p>
  </header>

  <div class="toolbar panel">
    <div class="seg" id="topicSeg">
      <div class="chip active" data-topic="animals">ğŸ¾ å‹•ç‰©</div>
      <div class="chip" data-topic="foods">ğŸ é£Ÿç‰©</div>
      <div class="chip" data-topic="objects">ğŸ  ç‰©å“</div>
      <div class="chip" data-topic="phrases">ğŸ’¬ ç”Ÿæ´»å¥å‹</div>
    </div>
    <div class="seg" id="modeSeg">
      <div class="chip active" data-mode="mix">ğŸ² æ··åˆ</div>
      <div class="chip" data-mode="listen">ğŸ”Š è½éŸ³é¸å­—</div>
      <div class="chip" data-mode="picture">ğŸ–¼ï¸ çœ‹åœ–é¸å­—</div>
      <div class="chip" data-mode="spell">ğŸ”¡ æ‹¼å­—</div>
      <div class="chip" data-mode="sentence">ğŸ—£ï¸ å¥å‹</div>
    </div>
  </div>

  <div class="panel" id="card">
    <div class="q-type" id="qType">æº–å‚™ä¸­â€¦</div>
    <div class="question" id="question"></div>
    <div id="mcArea" class="opts"></div>

    <div id="spellArea" class="hidden">
      <div class="slots" id="slots"></div>
      <div class="letters" id="letters"></div>
      <div class="actions">
        <button class="btn ghost" id="btnClear">æ¸…é™¤</button>
        <button class="btn primary" id="btnSubmit">é€å‡º</button>
        <button class="btn ghost" id="btnHint">æç¤ºä¸€å€‹å­—æ¯</button>
      </div>
    </div>

    <div class="actions">
      <button class="btn ghost" id="btnReplay">é‡æ’­èªéŸ³</button>
      <button class="btn primary" id="btnNext">ä¸‹ä¸€é¡Œ</button>
    </div>
  </div>

  <div id="toast" class="toast">Good!</div>

  <script>
    const TOPICS=["animals","foods","objects","phrases"];
    let BANK={animals:[],foods:[],objects:[],phrases:[]};

    async function loadTopic(t){
      try{
        const r=await fetch(`data/en/${t}.json`,{cache:'no-store'});
        if(!r.ok)throw 0;
        const d=await r.json();
        return d.items||[];
      }catch{return [];}
    }

    async function loadAll(){
      const [A,F,O,P]=await Promise.all(TOPICS.map(loadTopic));
      BANK.animals=A; BANK.foods=F; BANK.objects=O; BANK.phrases=P;
    }

    const state={topic:'animals',mode:'mix',autoVoice:true,current:null};
    const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
    const qType=$('#qType'),question=$('#question'),mc=$('#mcArea'),spell=$('#spellArea'),slots=$('#slots'),letters=$('#letters');
    const btnNext=$('#btnNext'),btnReplay=$('#btnReplay'),btnClear=$('#btnClear'),btnSubmit=$('#btnSubmit'),btnHint=$('#btnHint'),toast=$('#toast');

    function speak(t){if(!state.autoVoice)return;try{const u=new SpeechSynthesisUtterance(t);const en=speechSynthesis.getVoices().find(v=>/en/i.test(v.lang));if(en)u.voice=en;speechSynthesis.cancel();speechSynthesis.speak(u);}catch{}}
    const rnd=n=>Math.floor(Math.random()*n);
    const shuffle=a=>a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
    const pop=t=>{toast.textContent=t;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),900);};
    const nextMode=()=>state.topic==='phrases'?['sentence','listen'][rnd(2)]:['listen','picture','spell'][rnd(3)];

    function newRound(){
      mc.innerHTML='';spell.classList.add('hidden');slots.innerHTML='';letters.innerHTML='';question.innerHTML='';
      const mode=state.mode==='mix'?nextMode():state.mode;
      // ç¢ºä¿å¥å‹è‡ªå‹•åˆ‡ä¸»é¡Œ
      if (mode === 'sentence' && state.topic !== 'phrases') {
        state.topic = 'phrases';
        $$('#topicSeg .chip').forEach(c => c.classList.toggle('active', c.dataset.topic === 'phrases'));
      }
      const bank=BANK[state.topic];
      if(!bank?.length){question.textContent='æ­¤ä¸»é¡Œå°šç„¡é¡Œåº«';return;}
      if(mode==='sentence'){
        const it=bank[rnd(bank.length)];
        state.current={mode,s:it.s,ans:it.resp[0]};
        qType.textContent='ğŸ—£ï¸ å¥å‹';
        question.textContent=it.s;
        const opts=[it.resp[0],...shuffle(it.resp.slice(1))];
        opts.forEach(o=>mc.appendChild(opt(o,o===it.resp[0])));
        speak(it.s);
        return;
      }
      const it=bank[rnd(bank.length)];
      if(mode==='listen'){state.current={mode,ans:it.w};qType.textContent='ğŸ”Š è½éŸ³é¸å­—';question.innerHTML='<span>è«‹è½èªéŸ³é¸æ­£ç¢ºå–®å­—</span>';const opts=[it,...shuffle(bank.filter(x=>x!==it)).slice(0,1)];opts.forEach(o=>mc.appendChild(opt(o.w,o===it)));speak(it.w);setTimeout(()=>speak(it.w),600);return;}
      if(mode==='picture'){state.current={mode,ans:it.w};qType.textContent='ğŸ–¼ï¸ çœ‹åœ–é¸å­—';question.innerHTML=`<span class='big-emoji'>${it.emoji||'â”'}</span>`;const opts=[it,...shuffle(bank.filter(x=>x!==it)).slice(0,1)];opts.forEach(o=>mc.appendChild(opt(o.w,o===it)));speak(it.w);return;}
      if(mode==='spell'){state.current={mode,ans:it.w};qType.textContent='ğŸ”¡ æ‹¼å­—';question.innerHTML=`<span class='big-emoji'>${it.emoji||'â”'}</span>`;setupSpell(it.w);speak(it.w);}
    }

    const opt=(t,ok)=>{const e=document.createElement('div');e.className='opt';e.textContent=t;e.onclick=()=>{if(ok){e.classList.add('correct');pop('âœ… Good job!');setTimeout(newRound,700);}else{e.classList.add('wrong');pop('âŒ Try again');}};return e;};

    function setupSpell(a){
      mc.innerHTML='';spell.classList.remove('hidden');
      const pool=shuffle(a.split(''));const sl=[];
      for(let i=0;i<a.length;i++){const s=document.createElement('div');s.className='kbd';s.textContent='_';slots.appendChild(s);sl.push(s);}
      pool.forEach(c=>{const b=document.createElement('button');b.className='kbd';b.textContent=c;b.onclick=()=>place(b);letters.appendChild(b);});
      function place(b){const e=sl.find(x=>x.textContent=='_');if(!e)return;e.textContent=b.textContent;b.disabled=true;}
      btnClear.onclick=()=>{sl.forEach(s=>s.textContent='_');$$('#letters .kbd').forEach(b=>b.disabled=false);};
      btnSubmit.onclick=()=>{const g=sl.map(s=>s.textContent).join('');if(g===a){pop('âœ… Perfect!');setTimeout(newRound,700);}else pop('âŒ Oops');};
      btnHint.onclick=()=>{const i=sl.findIndex(x=>x.textContent=='_');if(i===-1)return;sl[i].textContent=a[i];const b=[...document.querySelectorAll('#letters .kbd')].find(b=>b.textContent===a[i]&&!b.disabled);if(b)b.disabled=true;};
    }

    $('#topicSeg').onclick=e=>{const t=e.target.closest('.chip');if(!t)return;state.topic=t.dataset.topic;$$('#topicSeg .chip').forEach(c=>c.classList.toggle('active',c===t));newRound();};

    // æ–¹æ¡ˆAï¼šé¸å¥å‹æ™‚è‡ªå‹•åˆ‡æ›ä¸»é¡Œ
    $('#modeSeg').onclick = e => {
      const t = e.target.closest('.chip');
      if (!t) return;
      state.mode = t.dataset.mode;

      if (state.mode === 'sentence' && state.topic !== 'phrases') {
        state.topic = 'phrases';
        $$('#topicSeg .chip').forEach(c =>
          c.classList.toggle('active', c.dataset.topic === 'phrases')
        );
      }

      $$('#modeSeg .chip').forEach(c => c.classList.toggle('active', c === t));
      newRound();
    };

    btnNext.onclick=newRound;
    btnReplay.onclick=()=>{if(!state.current)return;speak(state.current.ans||state.current.s);};

    (async()=>{await loadAll();newRound();})();
  </script>
</body>
</html>
