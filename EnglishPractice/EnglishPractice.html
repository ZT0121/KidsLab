<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KidsLabï½œEnglish Practice</title>
  <!-- å…±ç”¨æ¨£å¼èˆ‡å­—é«”ï¼ˆæ²¿ç”¨ä½ çš„ KidsLab çµæ§‹ï¼‰ -->
  <link rel="stylesheet" href="../KidsLabTheme-vFinal.css">
  <link rel="preload" as="font" href="../BpmfIansui-Regular.ttf" type="font/ttf" crossorigin>
  <link rel="preload" as="font" href="../Iansui-Regular.ttf" type="font/ttf" crossorigin>
  <style>
    :root { --card-w: 920px; }
    body { max-width: var(--card-w); margin: 0 auto; padding: 16px; font-family:'Iansui-Regular','Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto; }
    header h1 { margin: 8px 0 4px; }
    .lead { opacity: .8; margin: 0 0 16px; }

    .toolbar { display: grid; grid-template-columns: 1fr; gap: 10px; margin: 10px 0 14px; }
    @media(min-width:700px){ .toolbar{ grid-template-columns: 1fr 1fr; align-items: center; } }
    .seg { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .chip { border: 2px solid var(--b2, #93C5FD); border-radius: 999px; padding: 6px 12px; cursor: pointer; user-select: none; }
    .chip.active { background: var(--b2, #93C5FD); color: #002; font-weight: 700; }

    .panel { border: 2px solid var(--b2, #93C5FD); border-radius: 16px; padding: 16px; background: var(--b1, #F0F9FF); }
    .q-head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .q-type { font-size: 14px; opacity:.8; }

    .question { font-size: 20px; margin: 8px 0 14px; min-height: 28px; }
    .big-emoji { font-size: 64px; line-height: 1; }

    .opts { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
    @media (min-width: 640px){ .opts { grid-template-columns: repeat(3, minmax(0,1fr)); } }
    .opt { border:2px solid #BFDBFE; border-radius: 12px; padding: 12px; background:#fff; cursor:pointer; text-align:center; }
    .opt.correct { border-color: #22C55E; box-shadow: 0 0 0 3px rgba(34,197,94,.25) inset; }
    .opt.wrong { border-color: #EF4444; box-shadow: 0 0 0 3px rgba(239,68,68,.2) inset; }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight:700; border:2px solid #D1D5DB; border-radius: 6px; padding: 8px 10px; background:#fff; min-width:36px; display:inline-flex; align-items:center; justify-content:center; }
    .letters { display:flex; flex-wrap:wrap; gap:10px; }
    .slots { display:flex; flex-wrap:wrap; gap:10px; margin: 8px 0 12px; }

    .status { display:flex; flex-wrap:wrap; gap: 12px; align-items:center; }
    .pill { border:2px solid #93C5FD; padding:6px 10px; border-radius:999px; background:#fff; }

    .actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px; }
    button.btn { border:0; padding:10px 14px; border-radius: 10px; cursor:pointer; font-weight:700; }
    .btn.primary { background:#60A5FA; color:#001; }
    .btn.ghost { background:#fff; border:2px solid #93C5FD; }

    .hint { font-size: 14px; opacity:.8; margin-top: 6px; }
    .toast { position: fixed; left: 50%; top: 18px; transform: translateX(-50%); background:#111; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transition:opacity .18s; }
    .toast.show { opacity:1; }

    .hidden { display:none !important; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§  KidsLabï½œEnglish Practice</h1>
    <p class="lead">å››ä¸»é¡Œï¼šå‹•ç‰©ã€é£Ÿç‰©ã€ç‰©å“ã€ç”Ÿæ´»å¥å‹ã€‚å« Hunter æ¨¡å¼ã€‚</p>
  </header>

  <div class="toolbar panel">
    <div class="seg" id="topicSeg">
      <div class="chip active" data-topic="animals">ğŸ¾ å‹•ç‰©</div>
      <div class="chip" data-topic="foods">ğŸ é£Ÿç‰©</div>
      <div class="chip" data-topic="objects">ğŸ  ç‰©å“</div>
      <div class="chip" data-topic="phrases">ğŸ’¬ ç”Ÿæ´»å¥å‹</div>
    </div>
    <div class="seg" id="modeSeg">
      <div class="chip active" data-mode="mix">ğŸ² æ··åˆ</div>
      <div class="chip" data-mode="listen">ğŸ”Š è½éŸ³é¸å­—</div>
      <div class="chip" data-mode="picture">ğŸ–¼ï¸ çœ‹åœ–é¸å­—</div>
      <div class="chip" data-mode="spell">ğŸ”¡ æ‹¼å­—</div>
      <div class="chip" data-mode="sentence">ğŸ—£ï¸ å¥å‹</div>
    </div>
    <div class="seg" id="profileSeg">
      <div class="chip" data-profile="hunter">ğŸ§’ Hunter æ¨¡å¼</div>
      <div class="chip active" data-profile="default">ğŸ‘¤ ä¸€èˆ¬æ¨¡å¼</div>
    </div>
    <div class="seg">
      <label class="chip" style="display:flex;gap:6px;align-items:center;">
        <input id="toggleHint" type="checkbox" style="scale:1.2" /> å®¶é•·æç¤º
      </label>
      <label class="chip" style="display:flex;gap:6px;align-items:center;">
        <input id="toggleVoice" type="checkbox" style="scale:1.2" checked /> è‡ªå‹•æœ—è®€
      </label>
    </div>
  </div>

  <!-- é¡Œç›®å¡ -->
  <div class="panel" id="card">
    <div class="q-head">
      <div class="q-type" id="qType">æº–å‚™ä¸­â€¦</div>
      <div class="status">
        <div class="pill">LV <span id="lv">1</span></div>
        <div class="pill">â­ <span id="stars">0</span></div>
        <div class="pill">XP <span id="xp">0</span>/10</div>
      </div>
    </div>

    <div class="question" id="question"></div>

    <div id="mcArea" class="opts"></div>

    <div id="spellArea" class="hidden">
      <div class="slots" id="slots"></div>
      <div class="letters" id="letters"></div>
      <div class="actions">
        <button class="btn ghost" id="btnClear">æ¸…é™¤</button>
        <button class="btn primary" id="btnSubmit">é€å‡º</button>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnHint">æç¤ºä¸€å€‹å­—æ¯</button>
      </div>
      <div class="hint" id="spellHint" style="display:none;"></div>
    </div>

    <div class="actions">
      <button class="btn ghost" id="btnReplay">é‡æ’­èªéŸ³</button>
      <button class="btn primary" id="btnNext">ä¸‹ä¸€é¡Œ</button>
    </div>
  </div>

  <div class="hint" id="parentHint" style="display:none; margin-top:8px;">
    å®¶é•·æç¤ºï¼šè«‹å­©å­å…ˆè½ 2 æ¬¡å†ä½œç­”ã€‚åªéœ€é¼“å‹µï¼Œä¸ç³¾æ­£ç™¼éŸ³ã€‚
  </div>

  <div id="toast" class="toast">Good!</div>

  <script>
    // ========== å¤–éƒ¨é¡Œåº«è¼‰å…¥ ==========
    const TOPICS = ["animals","foods","objects","phrases"];
    let BANK = { animals:[], foods:[], objects:[], phrases:[] };

    async function loadTopic(topic){
      try{
        const res = await fetch(`data/en/${topic}.json`, {cache:'no-store'});
        if (!res.ok) throw new Error('net');
        const data = await res.json();
        return data.items || [];
      }catch(e){
        console.warn(`[BANK] ${topic} è¼‰å…¥å¤±æ•—ï¼Œæ”¹ç”¨å…§å»º`);
        return null; // äº¤çµ¦ fallback
      }
    }

    async function loadAllBanks(){
      const results = await Promise.all(TOPICS.map(t=>loadTopic(t)));
      const [A,F,O,P] = results;
      BANK.animals = A || [
        { w:'cat', zh:'è²“', emoji:'ğŸ±' },
        { w:'dog', zh:'ç‹—', emoji:'ğŸ¶' },
        { w:'fish', zh:'é­š', emoji:'ğŸŸ' },
        { w:'bird', zh:'é³¥', emoji:'ğŸ¦' }
      ];
      BANK.foods = F || [
        { w:'apple', zh:'è˜‹æœ', emoji:'ğŸ' },
        { w:'milk', zh:'ç‰›å¥¶', emoji:'ğŸ¥›' },
        { w:'bread', zh:'éºµåŒ…', emoji:'ğŸ' },
        { w:'rice', zh:'ç™½é£¯', emoji:'ğŸš' }
      ];
      BANK.objects = O || [
        { w:'bag', zh:'æ›¸åŒ…', emoji:'ğŸ’' },
        { w:'door', zh:'é–€', emoji:'ğŸšª' },
        { w:'book', zh:'æ›¸', emoji:'ğŸ“–' },
        { w:'ball', zh:'çƒ', emoji:'âš½' }
      ];
      BANK.phrases = P || [
        { s:'Wash your hands, please.', zh:'è«‹æ´—æ‰‹ã€‚', resp:['Okay!','I am a cat.','Banana.'] },
        { s:'Time for bed!', zh:'ç¡è¦ºæ™‚é–“åˆ°äº†ï¼', resp:['Okay, good night!','I am hungry.','Open the door.'] }
      ];
    }

    // ========== ç‹€æ…‹èˆ‡æœ¬åœ°å„²å­˜ ==========
    const state = {
      topic: localStorage.getItem('en_topic') || 'animals',
      mode: localStorage.getItem('en_mode') || 'mix',
      lv: parseInt(localStorage.getItem('en_lv') || '1', 10),
      xp: parseInt(localStorage.getItem('en_xp') || '0', 10),
      stars: parseInt(localStorage.getItem('en_stars') || '0', 10),
      difficulty: localStorage.getItem('en_diff') || 'standard',
      profile: localStorage.getItem('en_profile') || 'default',
      autoVoice: localStorage.getItem('en_autovoice') !== '0',
      hint: localStorage.getItem('en_hint') === '1',
      current: null,
    };

    // ========== DOM å¿«æ· ==========
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const qType = $('#qType');
    const question = $('#question');
    const mcArea = $('#mcArea');
    const spellArea = $('#spellArea');
    const slots = $('#slots');
    const letters = $('#letters');
    const btnNext = $('#btnNext');
    const btnReplay = $('#btnReplay');
    const btnClear = $('#btnClear');
    const btnSubmit = $('#btnSubmit');
    const btnHint = $('#btnHint');
    const lvEl = $('#lv');
    const xpEl = $('#xp');
    const starsEl = $('#stars');
    const parentHint = $('#parentHint');
    const toggleHint = $('#toggleHint');
    const toggleVoice = $('#toggleVoice');
    const toast = $('#toast');

    function save(){
      localStorage.setItem('en_topic', state.topic);
      localStorage.setItem('en_mode', state.mode);
      localStorage.setItem('en_lv', String(state.lv));
      localStorage.setItem('en_xp', String(state.xp));
      localStorage.setItem('en_stars', String(state.stars));
      localStorage.setItem('en_diff', state.difficulty);
      localStorage.setItem('en_profile', state.profile);
      localStorage.setItem('en_autovoice', state.autoVoice ? '1' : '0');
      localStorage.setItem('en_hint', state.hint ? '1' : '0');
    }
    function updateHUD(){
      lvEl.textContent = state.lv; xpEl.textContent = state.xp; starsEl.textContent = state.stars;
      parentHint.style.display = state.hint ? 'block' : 'none';
      toggleHint.checked = state.hint; toggleVoice.checked = state.autoVoice;
      $$('#topicSeg .chip').forEach(c=>c.classList.toggle('active', c.dataset.topic===state.topic));
      $$('#modeSeg .chip').forEach(c=>c.classList.toggle('active', c.dataset.mode===state.mode));
      $$('#profileSeg .chip').forEach(c=>c.classList.toggle('active', c.dataset.profile===state.profile));
    }

    // ========== èªéŸ³ ==========
    function speak(text){
      if (!state.autoVoice) return;
      try{
        const u = new SpeechSynthesisUtterance(text);
        const en = speechSynthesis.getVoices().find(v=>/en/i.test(v.lang));
        if (en) u.voice = en;
        u.rate = 0.95;
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch{}
    }

    // ========== å·¥å…· ==========
    const rnd = n => Math.floor(Math.random()*n);
    function shuffle(arr){ return arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
    function popToast(t){ toast.textContent = t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 900); }

    function choiceCountForMode(mode){
      const d = state.difficulty;
      const map = {
        listen:   { easy: 2, standard: 3, hard: 4 },
        picture:  { easy: 2, standard: 3, hard: 4 },
        sentence: { easy: 2, standard: 3, hard: 4 }
      };
      return (map[mode] && map[mode][d]) || 3;
    }
    function pickN(list, correct, n){
      const arr = shuffle(list.filter(x=> (x.w||x.s) !== (correct.w||correct.s)));
      const need = Math.max(0, n-1);
      return shuffle([correct, ...arr.slice(0, need)]);
    }
    function lettersWithDifficulty(answer){
      if (state.difficulty === 'hard'){
        const alphabet = 'abcdefghijklmnopqrstuvwxyz';
        const extras = [];
        while (extras.length < 2){
          const ch = alphabet[Math.floor(Math.random()*alphabet.length)];
          if (!answer.includes(ch)) extras.push(ch);
        }
        return shuffle([...answer.split(''), ...extras]);
      }
      if (state.difficulty === 'standard'){
        const alphabet = 'abcdefghijklmnopqrstuvwxyz';
        let extra = alphabet[Math.floor(Math.random()*alphabet.length)];
        while (answer.includes(extra)) extra = alphabet[Math.floor(Math.random()*alphabet.length)];
        return shuffle([...answer.split(''), extra]);
      }
      return shuffle(answer.split(''));
    }

    function reward(ok=true){ if(!ok) return; state.xp += 1; if (state.xp >= 10) { state.xp=0; state.lv+=1; state.stars+=1; popToast('LV UP â­'); } save(); updateHUD(); }

    function nextModeForMix(){
      const pool = state.topic === 'phrases' ? ['sentence','listen'] : ['listen','picture','spell'];
      return pool[rnd(pool.length)];
    }

    // ========== å‡ºé¡Œ ==========
    function newRound(){
      mcArea.innerHTML = '';
      spellArea.classList.add('hidden'); slots.innerHTML = ''; letters.innerHTML = ''; question.innerHTML = '';

      let mode = state.mode === 'mix' ? nextModeForMix() : state.mode;
      const bank = BANK[state.topic];
      if (!bank || bank.length===0){ question.textContent = 'æ­¤ä¸»é¡Œå°šç„¡é¡Œåº«'; return; }

      if (mode === 'sentence'){
        const item = bank[rnd(bank.length)]; // {s, resp}
        state.current = { mode, s:item.s, zh:item.zh, ans:item.resp[0] };
        qType.textContent = 'ğŸ—£ï¸ å¥å‹ï¼šé¸å‡ºè‡ªç„¶å›æ‡‰';
        question.textContent = item.s;
        const n = choiceCountForMode('sentence');
        const opts = [item.resp[0], ...shuffle(item.resp.slice(1))].slice(0,n);
        opts.forEach(o => mcArea.appendChild(renderOpt(o, o === item.resp[0])));
        speak(item.s);
        return;
      }

      const item = bank[rnd(bank.length)]; // å–®å­—é¡ {w, zh, emoji}

      if (mode === 'listen'){
        state.current = { mode, ans:item.w, zh:item.zh };
        qType.textContent = 'ğŸ”Š è½éŸ³é¸å­—';
        question.innerHTML = '<span class="hint">è«‹è½èªéŸ³ï¼Œé¸æ­£ç¢ºå–®å­—</span>';
        const opts = pickN(bank, item, choiceCountForMode('listen'));
        opts.forEach(o => mcArea.appendChild(renderOpt(o.w, o===item)));
        speak(item.w); setTimeout(()=>{ if(state.difficulty==='easy') speak(item.w); }, 600);
        return;
      }

      if (mode === 'picture'){
        state.current = { mode, ans:item.w, zh:item.zh };
        qType.textContent = 'ğŸ–¼ï¸ çœ‹åœ–é¸å­—';
        question.innerHTML = `<span class="big-emoji" aria-label="${item.w}">${item.emoji || 'â”'}</span>`;
        const opts = pickN(bank, item, choiceCountForMode('picture'));
        opts.forEach(o => mcArea.appendChild(renderOpt(o.w, o===item)));
        speak(item.w);
        return;
      }

      if (mode === 'spell'){
        state.current = { mode, ans:item.w, zh:item.zh };
        qType.textContent = 'ğŸ”¡ æ‹¼å­—ï¼šæ‹–æ”¾å­—æ¯çµ„æˆæ­£ç¢ºå–®å­—';
        question.innerHTML = `<span class="big-emoji">${item.emoji || 'â”'}</span>`;
        setupSpelling(item.w);
        speak(item.w);
        return;
      }
    }

    function renderOpt(text, isCorrect){
      const el = document.createElement('div');
      el.className = 'opt'; el.textContent = text;
      el.addEventListener('click', () => {
        if (el.classList.contains('correct') || el.classList.contains('wrong')) return;
        if (isCorrect){ el.classList.add('correct'); popToast('Nice!'); reward(true); }
        else { el.classList.add('wrong'); popToast('Try again'); }
      });
      return el;
    }

    function setupSpelling(answer){
      mcArea.innerHTML = '';
      spellArea.classList.remove('hidden');
      $('#spellHint').style.display = state.hint ? 'block' : 'none';
      $('#spellHint').textContent = `æç¤ºï¼š${answer}ï¼ˆ${state.current.zh}ï¼‰`;

      const lettersPool = lettersWithDifficulty(answer);
      const slotEls = [];
      for (let i=0;i<answer.length;i++){
        const s = document.createElement('div'); s.className = 'kbd'; s.dataset.slot = i; s.textContent = '_';
        slots.appendChild(s); slotEls.push(s);
      }
      lettersPool.forEach(ch => { const k = document.createElement('button'); k.className='kbd'; k.textContent=ch; k.dataset.char=ch; k.addEventListener('click',()=>placeChar(k)); letters.appendChild(k); });

      if (state.difficulty === 'easy' && slotEls.length){
        slotEls[0].textContent = answer[0];
        const firstBtn = Array.from(document.querySelectorAll('#letters .kbd')).find(b=>b.dataset.char===answer[0] && !b.disabled);
        if (firstBtn) firstBtn.disabled = true;
      }

      function placeChar(btn){
        const empty = slotEls.find(x=>x.textContent === '_'); if (!empty) return; empty.textContent = btn.dataset.char; btn.disabled = true;
      }
      btnClear.onclick = () => { slotEls.forEach(s=>s.textContent='_'); $$('#letters .kbd').forEach(b=>b.disabled=false); };
      btnSubmit.onclick = () => { const guess = slotEls.map(s=>s.textContent).join(''); if (guess === answer){ popToast('Perfect'); reward(true); } else { popToast('Oops'); } };
      btnHint.onclick = () => {
        if (state.difficulty === 'hard'){ popToast('æŒ‘æˆ°æ¨¡å¼ç„¡æç¤º'); return; }
        const idx = slotEls.findIndex(x=>x.textContent === '_'); if (idx === -1) return;
        slotEls[idx].textContent = answer[idx];
        const btn = Array.from(document.querySelectorAll('#letters .kbd')).find(b=>b.dataset.char===answer[idx] && !b.disabled);
        if (btn) btn.disabled = true;
      };
    }

    // ========== äº‹ä»¶ ==========
    $('#topicSeg').addEventListener('click', e => { const t=e.target.closest('.chip'); if(!t) return; state.topic=t.dataset.topic; save(); updateHUD(); newRound(); });
    $('#modeSeg').addEventListener('click', e => { const t=e.target.closest('.chip'); if(!t) return; state.mode=t.dataset.mode; save(); updateHUD(); newRound(); });
    $('#profileSeg').addEventListener('click', e => {
      const t=e.target.closest('.chip'); if(!t) return; const p=t.dataset.profile; state.profile=p;
      if (p==='hunter'){ state.difficulty='easy'; state.hint=true; state.autoVoice=true; state.topic = state.topic==='phrases' ? 'animals' : state.topic; }
      else { state.difficulty='standard'; }
      save(); updateHUD(); newRound();
    });

    btnNext.addEventListener('click', newRound);
    btnReplay.addEventListener('click', () => { if (!state.current) return; if (state.current.mode==='sentence') speak(state.current.s); else if (state.current.ans) speak(state.current.ans); });
    toggleHint.addEventListener('change', () => { state.hint = toggleHint.checked; save(); updateHUD(); });
    toggleVoice.addEventListener('change', () => { state.autoVoice = toggleVoice.checked; save(); });

    // ========== å•Ÿå‹• ==========
    (async function init(){
      await loadAllBanks();
      updateHUD();
      newRound();
    })();
  </script>
</body>
</html>
